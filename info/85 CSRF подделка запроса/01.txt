85 CSRF атака

Cross-Site Request Forgery
Межсайтовая подделка запроса

---

Cookies same-origin policy

(https://developer.mozilla.org/ru/docs/Web/Security/Same-origin_policy)
Политика одинакового источника (same-origin policy)
определяет как документ или скрипт, загруженный из одного
источника (origin), может взаимодействовать с ресурсом
из другого источника. Это помогает изолировать потенциально
вредоносные документы, снижая количество возможных векторов атак.

---

CSRF на примере
Скрытая форма на сайте злоумышленника, которая используя
ваш валидный куки и одинаковую форму (страницу) с hidden полями
с валидным сайтом (например сайтом банка)
отправляет ему неправильные данные (например делает перевод на
счет зловреда) JS даже автоматически может нажать на кнопку
отправки данных.

---

Как защититься от это атаки
(CSRF_token.png)

Мы отдаем формы пользователю.
Мы можем встраивать в формы динамический контент (с помощью
Thymeleaf)
В каждую форму встраивается специальный токен, который
генерируется каждый раз на стороне сервера и который может быть
использован лишь один раз
Формы, которые приходят к нам без этого токена (или с неправильным
токеном) не принимаются
Алгоритм генерации токена известен только нам (можем генерировать
его случайно на основании куки

---

Практика

Отключаем временную настройку в SecurityConfig,
отключающую CSRF защиту.
По умолчанию она включена

Добавляем CSRF токен в форму аутентификации
templates/auth/login.html
<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
а во все остальные формы этот токен
будет добавлен автоматически

После начала использования CSRF токенов мы должны изменить
кнопку LOGOUT, переделать её с гет на пост запрос
эта кнопка у нас на странице hello

---

Тестирование

После запуска проекта заходим на
http://localhost:8080/auth/login
По правой кнопке выбираем - Посмотреть код
и видим  наш csrf токен типа
<input type="hidden" name="_csrf" value="87159c0f-5939-4758-abc0-6365d336ce1b">

и на всех страницах зарегистрированного пользователя
мы видим такие токины